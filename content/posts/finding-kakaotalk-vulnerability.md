---
author: "naijun0403 and dadami-io on kirutia"
title: "Finding Kakaotalk's Vulnerability"
date: "2023-02-01"
description: "Finding Kakaotalk's zero-day vulnerability and providing solutions"
tags: ["kakaotalk"]
ShowToc: false
ShowBreadCrumbs: false
---

> 이 포스트는 카카오측에서 관련 문의에 대한 답변을 받은 후, 재발 방지의 차원으로 작성되었습니다. 
> 이후 저술할 내용과 관련하여 게시 중단 요청을
> 원하신다면 contact@kakao.gay 로 연락 부탁드립니다.
---
이 포스트에서는 필자가 Voxness라고 명명한 카카오톡의 zero-day 취약점을 발견하였던 과정과 솔루션을 제공하였던 과정에 대하여 알아봅니다. **이 취약점은 2023년 1월 31일자로 조치가 완료된 취약점 입니다.** 해당 취약점의 최초 발견자는 @storycraft, @blluv 입니다.


## Voxness
Vox는 (주) 카카오에서 카카오톡의 보이스톡 기능을 위하여 개발한 음성 메신저 프로토콜 입니다.
이 프로토콜의 전체적인 구조는, 보이스톡이 처음 출시된 2012년과 크게 다르지 않습니다.

아래는 클라이언트가 다른 사용자에게 보이스톡을 거는 과정입니다.

 1. 보이스톡의 발신 클라이언트는 수신 클라이언트에 type 51의 보이스톡 발신 메세지를 전송합니다.
 2. 해당 메세지에는 csIP와 callId라는 인자가 포함됩니다. 아래는 보이스톡 발신 메세지의 개념입니다.
 ``` javascript
const att = {
    type: 'invite',
    csIP: 'csIP',
    csIP6: 'csIPv6',
    csPort: csPort,
    callId: randomNumber(), // random 17 length number
    duration: 0
}
```
3. 보이스톡 발신 메세지를 수신한 카카오톡 클라이언트는 수신받은 메세지의 csIP로 연결을 시도합니다.
4. 이때 사용되는 암호화 방식은 2021년에 [EOL](https://datatracker.ietf.org/doc/html/rfc8996)된 Tls v1.0 입니다.
5. 수신받은 csIP로 연결을 시도할 때, 클라이언트와 카카오톡의 서버는 csIP가 카카오 소유의 올바른 call server IP인지 확인하지 않습니다.
6. csIP로 연결을 시도한 클라이언트는, call server에 accessToken, deviceUUID, os, ip 등등 주요 정보를 전송합니다.
7. 전달받은 정보를 통하여 인증 과정을 거친 후, 보이스톡이 시작됩니다.

3번에서, 보이스톡 발신 메세지에 있는 csIP를 공격자가 임의로 수정하여 전송하게 되면,
수신 클라이언트는 임의로 수정된 csIP로 연결을 시도하게 됩니다. 
그리고 **임의로 수정된 call server**에 **accessToken**, deviceUUID, os, ip 등 중요 정보를 전송하게 됩니다.
보이스톡 메세지를 수신만 하고 실제로 받지 않더라도 클라이언트는 연결을 시도하기 때문에,
**신원을 모르는 제 3자가 유저에게 보이스톡 메세지만 전송하면 수신한 유저의 계정 정보를 탈취할 수 있게 됩니다.**
탈취된 계정 정보들을 사용하여 공격자는 로그인, 메세지 전송, 카카오 계정 탈퇴 등 이론상 모든 동작을 수행할 수 있습니다.

해당 Vox 프로토콜은 보이스톡(단체 포함), 페이스톡, 보이스룸 등에서 사용됩니다.


## 해결방안 제시 및 해결
해당 취약점을 2차적으로 발견한 필자들은([naijun0403](https://github.com/naijun0403) and [dadami-io](https://github.com/dadami-io)),
이 zero-day 취약점이 언제든 악용될 수 있으며,
만약 악용된다면 전 국가적 피해가 지속되리라 예측하였습니다. 
실제로 이를 악용하여 랜덤한 사람들을 탈퇴시킨 공격자들이 있으며,
체이닝을 사용하여 전 국민을 탈퇴시킬 수 있었던 위험한 취약점이였습니다.
이론상, **14개의 계정으로 7번 체이닝**(계정 탈취 및 해당 계정에 등록된 친구들의 계정 탈취) 한다면
5000만 국민의 카카오 계정 계정정보를 탈취할 수 있습니다.

가능한 모든 방법을 사용하여 카카오톡 보안팀에 관련 사실을 제보하였고,
2영업일 이후 긴급 픽스가 이루어졌습니다.
해당 취약점을 악용한 계정은 모두 정지처리 되었으며,
csIP를 조작한 메세지는 더이상 전송이 불가능합니다.
필자가 카카오측에 제시한 서버단 체킹이 이루어진 모습을 확인할 수 있었습니다.

## 재발 방지를 위한 방법
Voxness가 쉽게 악용될 수 있었던 이유 중 하나는 Vox 프로토콜이
**Tls v1.0 (self-signed)** 를 암호화 방식으로 사용하기 때문이었습니다.
EOL된 암호화 방식을 사용하지 않고,
SSL Pinning 기법 도입을 통하여 해당 공격을 미리 방지할 수 있었습니다.

카카오톡이 해당 취약점과 관련된 모든 문제를 빠르게 인지하고,
대처한 점에 찬사를 보내며,
보이스톡 관련 프로토콜의 전체적인 리팩토링을 희망하며 포스트를 마무리합니다.
